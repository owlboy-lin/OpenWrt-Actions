# 
# <https://github.com/KFERMercer/OpenWrt-CI>
#
# Copyright (C) 2019 P3TERX
#
# Copyright (C) 2020 KFERMercer
# chmod +x /etc/init.d/netspeedtest

name: JBT-immortalwrt-24.10

on:
  schedule:
    - cron: 0 22 * * *
    #      åˆ†,æ—¶,æ—¥,æœˆ,å‘¨ã€‚æ¯å‘¨äº” 20æ—¶æ‰§è¡Œä¸€æ¬¡ (UTCæ—¶é—´)
  release:
    types: [published]
  
  watch:
    types: [started]

  repository_dispatch:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: 'false'
        
      CACHE_BUILD:
        description: 'ç¼“å­˜åŠ é€Ÿ'
        required: false
        default: 'true'
        type: boolean


    
env:
  FREE_DISK_SH: scripts/free_disk_space.sh
  ENV_SH: scripts/environment.sh
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: openwrt-24.10
  Firmware_Name: JBT-immortalwrt
  CONFIG_FILE: configs/Packages-x86.txt
  SETTINGS_SH: scripts/init-settings.sh
  PACKAGES_SH: scripts/packages.sh
  CLASH_CORE_SH: scripts/preset-clash-core-amd64.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_BUILDINFO: true
  UPLOAD_PACKAGE: true
  UPLOAD_COWTRANSFER: false
  UPLOAD_WETRANSFER: false
  UPLOAD_RELEASE: true
  GITHUB_TOKEN: ${{ secrets.GIT_USER_TOKEN }}
  TZ: Asia/Shanghai  

jobs:

  build_openwrt:


    name: JBT-immortalwrt-24.10
    
    runs-on: Ubuntu-24.04
    
    steps:
      - name: æ£€æŸ¥
        uses: actions/checkout@main

      - name: åˆå§‹åŒ–ç¯å¢ƒ
        env:
            DEBIAN_FRONTEND: noninteractive
        run: |
          chmod +x $FREE_DISK_SH && $FREE_DISK_SH
          chmod +x $ENV_SH && $ENV_SH
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo timedatectl set-timezone "$TZ"
          docker image prune -a -f
          docker container prune -f
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir

      - name: æ£€æŸ¥ç©ºé—´ä½¿ç”¨æƒ…å†µ1
        if: (!cancelled())
        run: df -hT


      - name: æ›´æ–°æ—¶åŒºã€ç¼–è¯‘æ—¶é—´
        id: date
        run: |
          sudo timedatectl set-timezone "$TZ"
          echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
          echo "FILE_TIME=$(date +"%m-%d %H.%M")" >> $GITHUB_ENV
          echo "FILE_TIME1=$(date "+%Yå¹´%mæœˆ%dæ—¥-%Hç‚¹%Måˆ†")" >> $GITHUB_ENV
          echo "FILE_TIME2=$(date "+%Y%m%d-%H%M")" >> $GITHUB_ENV
          echo "ç¼–è¯‘å¼€å§‹æ—¶é—´..."
          START_TIME=`date +'%Y-%m-%d %H:%M:%S'`
          echo "START_SECONDS=$(date --date="$START_TIME" +%s)" >> $GITHUB_ENV

      - name: ä¸‹è½½æºä»£ç 
        working-directory: /workdir
        run: |
          git clone $REPO_URL --depth 1 -b $REPO_BRANCH openwrt
          ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt


      - name: è®¾ç½® VERSION ç¯å¢ƒå˜é‡
        run: echo "VERSION=${REPO_BRANCH#*-}" >> $GITHUB_ENV

      - name: ç¼“å­˜
        uses: klever1988/cachewrtbuild@main
        if: env.CACHE_BUILD == 'true' || (github.event.inputs.CACHE_BUILD == 'true')
        with:
          ccache: 'true'
          mixkey: '${{ env.VERSION }}_${{ env.Firmware_Name }}'
          prefix: ${{ github.workspace }}/openwrt

      - name: å®‰è£… feeds
        run: |
            cd openwrt
            ./scripts/feeds update -a
            ./scripts/feeds install -a

      - name: å¯¼å…¥è¡¥ä¸å’Œé…ç½® & æ‰§è¡Œè„šæœ¬
        run: |
            [ -d files ] && mv files openwrt/files || echo "files not found"
            [ -f $CONFIG_FILE ] && cat $CONFIG_FILE >> openwrt/.config
            cd openwrt
            chmod +x $GITHUB_WORKSPACE/$SETTINGS_SH && $GITHUB_WORKSPACE/$SETTINGS_SH
            chmod +x $GITHUB_WORKSPACE/$PACKAGES_SH && $GITHUB_WORKSPACE/$PACKAGES_SH
            chmod +x $GITHUB_WORKSPACE/$CLASH_CORE_SH && $GITHUB_WORKSPACE/$CLASH_CORE_SH          

      - name: SSH connection to Actions
        uses: P3TERX/ssh2actions@v1.0.0
        if: (github.event.inputs.ssh == 'true' && github.event.inputs.ssh  != 'false') || contains(github.event.action, 'ssh')
        env:
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}


      
      - name: ä¸‹è½½å›ºä»¶åŒ…
        run: |
            cd openwrt
            make defconfig
            make download -j8 V=10
            find dl -size -1024c -exec ls -l {} \;
            find dl -size -1024c -exec rm -f {} \;        

      - name: ç©ºé—´ä½¿ç”¨æƒ…å†µ2
        if: (!cancelled())
        run: df -hT

      - name: ç¼–è¯‘å·¥å…·é“¾
        id: mtools
        run: |
            cd openwrt
            make defconfig
            echo -e "$(($(nproc)+1)) thread compile"
            make tools/compile -j$(($(nproc)+1)) || make tools/compile -j1 V=s
            make toolchain/compile -j$(($(nproc)+1)) || make toolchain/compile -j1 V=s
            echo "status=success" >> $GITHUB_OUTPUT

      - name: ç©ºé—´ä½¿ç”¨æƒ…å†µ3_1
        if: (!cancelled())
        run: df -hT

      - name: æ¸…é™¤å·¥å…·é“¾ç¼–è¯‘ä¸­é—´äº§ç‰©...
        if: steps.mtools.outputs.status == 'success' && !cancelled()
        run: |
            cd openwrt
            rm -rf dl/*
            rm -rf build_dir/host/*
            rm -rf build_dir/toolchain-*

      - name: ç©ºé—´ä½¿ç”¨æƒ…å†µ3_2
        if: (!cancelled())
        run: df -hT

      - name: ç¼–è¯‘å†…æ ¸
        id: mkernel
        if: steps.mtools.outputs.status == 'success' && !cancelled()
        run: |
          cd openwrt
          echo -e "$(($(nproc)+1)) thread compile"
          make target/linux/compile -j$(($(nproc)+1)) || make target/linux/compile -j1 V=s
          echo "status=success" >> $GITHUB_OUTPUT
          grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' > DEVICE_NAME
          [ -s DEVICE_NAME ] && echo "DEVICE_NAME=_$(cat DEVICE_NAME)" >> $GITHUB_ENV
          echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV


      - name: ç©ºé—´ä½¿ç”¨æƒ…å†µ4
        if: (!cancelled())
        run: df -hT
        
      - name: ç¼–è¯‘æ’ä»¶
        id: mpackage
        if: steps.mkernel.outputs.status == 'success' && !cancelled()
        run: |
          cd openwrt
          echo -e "$(($(nproc)+1)) thread compile"
          make package/compile -j$(($(nproc)+1)) || make package/compile -j1 V=s
          make package/install -j$(nproc) || make package/install -j1 V=s
          make package/index
          echo "status=success" >> $GITHUB_OUTPUT
          
      - name: ç©ºé—´ä½¿ç”¨æƒ…å†µ5
        if: (!cancelled())
        run: df -hT

      - name: æ¸…é™¤æ’ä»¶ç¼–è¯‘æ–‡ä»¶
        id: cpackage
        if: steps.mpackage.outputs.status == 'success' && !cancelled()
        run: |
            cd openwrt
            rm -rf build_dir/target-*/host
            echo "status=success" >> $GITHUB_OUTPUT

      - name: ç©ºé—´ä½¿ç”¨æƒ…å†µ6
        if: (!cancelled())
        run: df -hT

      - name: ç¼–è¯‘å›ºä»¶
        id: compile
        if: steps.cpackage.outputs.status == 'success' && !cancelled()
        run: |
            cd openwrt
            echo -e "$(($(nproc)+1)) thread compile"
            make target/install -j$(nproc) || make target/install -j1 V=s
            make json_overview_image_info
            make checksum
            echo "status=success" >> $GITHUB_OUTPUT

      - name: ç©ºé—´ä½¿ç”¨æƒ…å†µ7
        if: (!cancelled())
        run: df -hT

      # - name: æ£€æŸ¥ç©ºé—´ä½¿ç”¨æƒ…å†µ
      #   if: steps.compile.outputs.status == 'success' && !cancelled()
      #   run: df -hT

      # - name: SSH connection to Actions
      #   uses: P3TERX/ssh2actions@v1.0.0
      #   if: (github.event.inputs.ssh == 'true' && github.event.inputs.ssh  != 'false') || contains(github.event.action, 'ssh')
      #   env:
      #     TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      #     TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}  

      - name: æ•´ç†æ–‡ä»¶
        id: organize
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true' && !cancelled()
        run: |
          cd openwrt/bin/targets/*/*
          # rm -rf packages
          echo "FIRMWARE=$PWD" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT

      - name: ä¸Šä¼ å®Œæ•´å›ºä»¶ç›®å½•
        uses: actions/upload-artifact@v4
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true' && !cancelled()
        with:
          name: ${{ env.Firmware_Name }}_${{ env.REPO_BRANCH }}_bin${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
          path: ${{ env.FIRMWARE }}
          
      - name: æ•´ç†å›ºä»¶æ–‡ä»¶
        id: artifact
        if: steps.compile.outputs.status == 'success' && !cancelled()
        run: |
          cd openwrt
          mkdir -p ./artifact/firmware
          mkdir -p ./artifact/package
          mkdir -p ./artifact/buildinfo
          rm -rf $(find ./bin/targets/ -type d -name "packages")
          cp -rf $(find ./bin/targets/ -type f) ./artifact/firmware/
          cp -rf $(find ./bin/packages/ -type f -name "*.ipk") ./artifact/package/
          cp -rf $(find ./bin/targets/ -type f -name "*.buildinfo" -o -name "*.manifest") ./artifact/buildinfo/
          cp -rf ./.config ./artifact/buildinfo/${{ env.Firmware_Name }}.info
          cp -rf ./.config ./artifact/firmware/${{ env.Firmware_Name }}.info
          cp -rf ./feeds.conf.default ./artifact/buildinfo/
          cd artifact/firmware/
          rename "s/openwrt/${{ env.Firmware_Name }}/" *
 
       
      - name: ä¸Šä¼ å›ºä»¶
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_FIRMWARE == 'true' && !cancelled()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.Firmware_Name }}_${{ env.REPO_BRANCH }}_firmware_${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
          path: openwrt/artifact/firmware/

      - name: ä¸Šä¼ é…ç½®æ–‡ä»¶
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_BUILDINFO == 'true' && !cancelled()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.Firmware_Name }}_${{ env.REPO_BRANCH }}_buildinfo${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
          path: openwrt/artifact/buildinfo/

      - name: ä¸Šä¼ æ’ä»¶
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_PACKAGE == 'true' && !cancelled()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.Firmware_Name }}_${{ env.REPO_BRANCH }}_package${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
          path: openwrt/artifact/package/

      - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
        id: tag
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true' && !cancelled()
        run: |
          echo "release_tag=$(date +"%Y.%m.%d.%H.%M")-${{ env.Firmware_Name }}" >> $GITHUB_OUTPUT
          echo "release_date=$(date +"%Y.%m.%d.%H.%M")" >> $GITHUB_OUTPUT
          touch release.txt
          echo "
          â˜… æºç  : ${{ env.REPO_URL }} 
          â˜… åˆ†æ”¯ : ${{ env.REPO_BRANCH }} 
          â˜… æ„Ÿè°¢æºç ä½œè€…æ— ç§åˆ†äº«ï¼
          
          â° ç¼–è¯‘æ—¶é—´ï¼š${{ env.FILE_TIME1 }}
          
          ğŸˆ å†…æ ¸ç‰ˆæœ¬ï¼š${{ env.KERNEL_PATCHVER }}
          
          ğŸ‰ ç¼–è¯‘ç‰ˆæœ¬ï¼š${{ env.DISTRIB_REVISION }}
          
          ğŸ–¥ ç®¡ç†åœ°å€ï¼š192.168.8.1 
          
          ğŸŒ´ åç§°ï¼šroot
          
          ğŸ›  å¯†ç ï¼špassword" >> release.txt
          echo "status=success" >> $GITHUB_OUTPUT
      
      - name: è‡ªåŠ¨å‘å¸ƒå›ºä»¶åˆ° Releases
        uses: softprops/action-gh-release@v2
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true' && !cancelled()
        env:
          GITHUB_TOKEN: ${{ secrets.GIT_USER_TOKEN }}
        with:
          name: ${{ steps.tag.outputs.release_date }} ${{ env.Firmware_Name }} ${{ env.name }}
          tag_name: ${{ steps.tag.outputs.release_tag }}
          body_path: release.txt
          files: openwrt/artifact/firmware/*

      # - name: åˆ é™¤è¿è¡Œè®°å½•
      #   uses: Mattraks/delete-workflow-runs@v2
      #   if: steps.compile.outputs.status == 'success' && !cancelled()
      #   continue-on-error: true
      #   with:
      #     retain_days: 3     #ä¿ç•™æœ€åå¤šå°‘è®°å½•ä¸åˆ é™¤
      #     keep_minimum_runs: 0

      - name: åˆ é™¤è‡ªåŠ¨å‘å¸ƒçš„æ—§å›ºä»¶
        uses: dev-drprasad/delete-older-releases@v0.3.3
        continue-on-error: true
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true' && !cancelled()
        with:
          keep_latest: 20        #ä¿ç•™å¤šå°‘ä¸ªreleasesä¸åˆ é™¤
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
  