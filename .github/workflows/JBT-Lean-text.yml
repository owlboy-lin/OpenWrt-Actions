# 
# <https://github.com/KFERMercer/OpenWrt-CI>
#
# Copyright (C) 2019 P3TERX
#
# Copyright (C) 2020 KFERMercer
# chmod +x /etc/init.d/netspeedtest

name: JBT-Lean-text

on:
  schedule:
    - cron: 0 22 * * *
    #      åˆ†,æ—¶,æ—¥,æœˆ,å‘¨ã€‚æ¯å‘¨äº” 20æ—¶æ‰§è¡Œä¸€æ¬¡ (UTCæ—¶é—´)
  release:
    types: [published]
  
  watch:
    types: [started]

  repository_dispatch:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: 'false'
        
      CACHE_BUILD:
        description: 'ç¼“å­˜åŠ é€Ÿ'
        required: false
        default: 'true'
        type: boolean


    
env:
  GITHUB_TOKEN: ${{ secrets.GIT_USER_TOKEN }}
  FREE_DISK_SH: scripts/free_disk_space.sh
  ENV_SH: scripts/environment.sh
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  Firmware_Name: JBT-Lean-text
  PLATFORM_FILE: configs/My-Target-X86.txt
  CONFIG_FILE: configs/My-Packages.txt
  # CONFIG_5G: configs/Packages-5G.txt
  SETTINGS_SH: scripts/JBT-init-settings.sh
  PACKAGES_SH: scripts/My-packages.sh
  # INSTALL5G_SH: scripts/install-5G.sh
  CLASH_CORE_SH: scripts/preset-clash-core-amd64.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_BUILDINFO: true
  UPLOAD_PACKAGE: true
  UPLOAD_COWTRANSFER: false
  UPLOAD_WETRANSFER: false
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai  

jobs:
  build_openwrt:

    name: JBT-Lean-text
    
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€æŸ¥
        uses: actions/checkout@main

      - name: æ£€æµ‹ /dev/sda1 åˆ†åŒºæ˜¯å¦å­˜åœ¨ï¼ˆOverlayéƒ¨åˆ†ï¼‰
        id: overlay
        run: |
          if [ ! -b /dev/sda1 ]; then
            echo "é”™è¯¯ï¼š/dev/sda1 åˆ†åŒºä¸å­˜åœ¨ï¼Œæ— æ³•ç»§ç»­æ‰§è¡Œ OverlayFS ç›¸å…³æ“ä½œï¼Œé€€å‡º Actionsï¼"
            exit 1  # é€€å‡ºå¹¶æ ‡è®° Actions æ‰§è¡Œå¤±è´¥
          fi
            echo "æˆåŠŸæ£€æµ‹åˆ° /dev/sda1 åˆ†åŒºï¼Œç»§ç»­æ‰§è¡Œåç»­æ­¥éª¤ã€‚"

      - name: åˆå§‹åŒ–ç¯å¢ƒ
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          # chmod +x $FREE_DISK_SH && $FREE_DISK_SH
          # sudo docker image prune --all --force
          # sudo -E apt-get -qq update -y
          # sudo -E apt-get -qq full-upgrade -y
          # chmod +x $ENV_SH && $ENV_SH
          # sudo rm -rf /etc/apt/sources.list.d/*
          # sudo rm -rf /var/lib/apt/lists/*
          # # è®¾ç½®æ—¶åŒº
          # sudo timedatectl set-timezone "$TZ"
          # sudo mkdir -p /workdir
          # sudo chown $USER:$GROUPS /workdir

          docker image prune -f
          sudo -E rm -rf /usr/share/dotnet /etc/mysql /etc/php /etc/apt/sources.list.d /usr/local/lib/android
          sudo -E apt-mark hold grub-efi-amd64-signed
          sudo -E apt update
          sudo -E apt -y purge azure-cli* docker* ghc* zulu* llvm* firefox google* dotnet* powershell* openjdk* mysql* php* mongodb* dotnet* snap*
          sudo -E apt -y full-upgrade
          sudo -E apt -y install ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential bzip2 ccache clang cmake cpio curl device-tree-compiler flex gawk gcc-multilib g++-multilib gettext genisoimage git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev libreadline-dev libssl-dev libtool llvm lrzsz msmtp ninja-build p7zip p7zip-full patch pkgconf python3 python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev
          sudo -E systemctl daemon-reload
          sudo -E apt -y autoremove --purge
          sudo -E apt clean
          sudo -E timedatectl set-timezone "Asia/Shanghai"
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir  

      - name: æ£€æŸ¥ç©ºé—´ä½¿ç”¨æƒ…å†µ
        if: (!cancelled())
        run: df -hT


      - name: æ›´æ–°æ—¶åŒºã€ç¼–è¯‘æ—¶é—´
        id: date
        run: |
          sudo timedatectl set-timezone "$TZ"
          echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
          echo "FILE_TIME=$(date +"%m-%d %H.%M")" >> $GITHUB_ENV
          echo "FILE_TIME1=$(date "+%Yå¹´%mæœˆ%dæ—¥-%Hç‚¹%Måˆ†")" >> $GITHUB_ENV
          echo "FILE_TIME2=$(date "+%Y%m%d-%H%M")" >> $GITHUB_ENV
          echo "ç¼–è¯‘å¼€å§‹æ—¶é—´..."
          START_TIME=`date +'%Y-%m-%d %H:%M:%S'`
          echo "START_SECONDS=$(date --date="$START_TIME" +%s)" >> $GITHUB_ENV

      - name: åˆ›å»º OverlayFS ç›®å½•ç»“æ„ï¼ˆOverlayéƒ¨åˆ†ï¼‰
        run: |
          sudo mkdir -p /overlay/lower
          sudo mkdir -p /mnt/overlay/upper
          sudo mkdir -p /mnt/overlay/work
          # ä¸‹é¢1è¡Œå»é™¤Overlayéœ€è¦è¿˜åŸåˆ° åˆå§‹åŒ–ç¯å¢ƒä¸­
          sudo mkdir -p /workdir
          sudo chmod 777 /overlay/lower
          sudo chmod 777 /mnt/overlay/upper

      - name: æŒ‚è½½ OverlayFS åˆå¹¶åˆ†åŒºï¼ˆOverlayéƒ¨åˆ†ï¼‰
        run: |
          sudo mount -t overlay overlay \
          -o rw,lowerdir=/overlay/lower,upperdir=/mnt/overlay/upper,workdir=/mnt/overlay/work /workdir
          mount | grep overlay

      - name: è®¾ç½® /workdir æƒé™ï¼ˆOverlayéƒ¨åˆ†ï¼‰
        run: |
          # ä¸‹é¢1è¡Œå»é™¤Overlayéœ€è¦è¿˜åŸåˆ° åˆå§‹åŒ–ç¯å¢ƒä¸­
          sudo chown $USER:$GROUPS /workdir

      - name: æ£€æŸ¥ç©ºé—´ä½¿ç”¨æƒ…å†µï¼ˆOverlayFSæ˜¯å¦ç”Ÿæ•ˆï¼‰
        if: (!cancelled())
        run: df -hT

      - name: å…‹éš†æºç 
        working-directory: /workdir
        run: |
          git clone $REPO_URL --depth 1 -b $REPO_BRANCH openwrt
          ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

          cd ./openwrt/ && echo "WRT_HASH=$(git log -1 --pretty=format:'%h')" >> $GITHUB_ENV

      - name: æ£€æŸ¥ç¼“å­˜
        id: check-cache
        uses: actions/cache@main
        with:
          key: x86-${{env.REPO_BRANCH}}-${{env.WRT_HASH}}
          restore-keys: x86-${{env.REPO_BRANCH}}
          path: |
            ./openwrt/.ccache
            ./openwrt/staging_dir/host*
            ./openwrt/staging_dir/tool*

      - name: å¼€å¯CCACHEé…ç½®
        run: |
          echo 'CONFIG_DEVEL=y' >> openwrt/.config
          echo 'CONFIG_CCACHE=y' >> openwrt/.config       
          
      - name: æ›´æ–°ç¼“å­˜
        run: |
          if [ -d "./openwrt/staging_dir" ]; then
            find "./openwrt/staging_dir" -type d -name "stamp" -not -path "*target*" | while read -r DIR; do
              find "$DIR" -type f -exec touch {} +
            done

            mkdir -p ./openwrt/tmp && echo "1" > ./openwrt/tmp/.build

            echo "toolchain skiped done!"
          else
            echo "caches missed!"
          fi

          if ${{steps.check-cache.outputs.cache-hit != 'true'}}; then
            CACHE_LIST=$(gh cache list --key "x86-$REPO_BRANCH" | cut -f 1)
            for CACHE_KEY in $CACHE_LIST; do
              gh cache delete $CACHE_KEY
            done
  
            echo "caches cleanup done!"
          fi

      - name: å®‰è£… feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: å¯¼å…¥è¡¥ä¸å’Œé…ç½® & æ‰§è¡Œè„šæœ¬
        run: |
          [ -d files ] && mv files openwrt/files || echo "files not found"
          [ -f $PLATFORM_FILE ] && cat $PLATFORM_FILE >> openwrt/.config
          [ -f $CONFIG_FILE ] && cat $CONFIG_FILE >> openwrt/.config
          # [ -f $CONFIG_5G ] && cat $CONFIG_5G >> openwrt/.config
          cd openwrt
          chmod +x $GITHUB_WORKSPACE/$SETTINGS_SH && $GITHUB_WORKSPACE/$SETTINGS_SH
          chmod +x $GITHUB_WORKSPACE/$PACKAGES_SH && $GITHUB_WORKSPACE/$PACKAGES_SH
          # chmod +x $GITHUB_WORKSPACE/$INSTALL5G_SH && $GITHUB_WORKSPACE/$INSTALL5G_SH
          chmod +x $GITHUB_WORKSPACE/$CLASH_CORE_SH && $GITHUB_WORKSPACE/$CLASH_CORE_SH
   

      - name: SSH connection to Actions
        uses: P3TERX/ssh2actions@v1.0.0
        if: (github.event.inputs.ssh == 'true' && github.event.inputs.ssh  != 'false') || contains(github.event.action, 'ssh')
        env:
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}


      
      - name: ä¸‹è½½å›ºä»¶åŒ…
        run: |
            cd openwrt
            make defconfig
            make download -j8 V=10
            find dl -size -1024c -exec ls -l {} \;
            find dl -size -1024c -exec rm -f {} \;        

      - name: ç©ºé—´ä½¿ç”¨æƒ…å†µ2
        if: (!cancelled())
        run: df -hT

      - name: ç¼–è¯‘å›ºä»¶
        id: compile
        run: |
          cd openwrt
          echo -e "$(nproc) thread compile"
          make -j$(nproc) || make -j1 || make -j1 V=s
          echo "======================="
          echo "Space usage:"
          echo "======================="
          df -h
          echo "======================="
          du -h --max-depth=1 ./ --exclude=build_dir --exclude=bin
          du -h --max-depth=1 ./build_dir
          du -h --max-depth=1 ./bin
          echo "status=success" >> $GITHUB_OUTPUT
          grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' > DEVICE_NAME
          [ -s DEVICE_NAME ] && echo "DEVICE_NAME=_$(cat DEVICE_NAME)" >> $GITHUB_ENV
          echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

      - name: ç©ºé—´ä½¿ç”¨æƒ…å†µï¼ˆç¼–è¯‘å ç”¨ï¼‰
        if: (!cancelled())
        run: df -hT


      - name: æ•´ç†æ–‡ä»¶
        id: organize
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true' && !cancelled()
        run: |
          cd openwrt/bin/targets/*/*
          # rm -rf packages
          echo "FIRMWARE=$PWD" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT

      - name: ä¸Šä¼ å®Œæ•´å›ºä»¶ç›®å½•
        uses: actions/upload-artifact@v4
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true' && !cancelled()
        with:
          name: ${{ env.Firmware_Name }}_${{ env.REPO_BRANCH }}_bin${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
          path: ${{ env.FIRMWARE }}
          
      - name: æ•´ç†å›ºä»¶æ–‡ä»¶
        id: artifact
        if: steps.compile.outputs.status == 'success' && !cancelled()
        run: |
          cd openwrt
          mkdir -p ./artifact/firmware
          mkdir -p ./artifact/package
          mkdir -p ./artifact/buildinfo
          rm -rf $(find ./bin/targets/ -type d -name "packages")
          cp -rf $(find ./bin/targets/ -type f) ./artifact/firmware/
          cp -rf $(find ./bin/packages/ -type f -name "*.ipk") ./artifact/package/
          cp -rf $(find ./bin/targets/ -type f -name "*.buildinfo" -o -name "*.manifest") ./artifact/buildinfo/
          cp -rf ./.config ./artifact/buildinfo/${{ env.Firmware_Name }}.info
          cp -rf ./.config ./artifact/firmware/${{ env.Firmware_Name }}.info
          cp -rf ./feeds.conf.default ./artifact/buildinfo/
          cd artifact/firmware/
          rename "s/openwrt/${{ env.Firmware_Name }}/" *
 
       
      - name: ä¸Šä¼ å›ºä»¶
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_FIRMWARE == 'true' && !cancelled()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.Firmware_Name }}_${{ env.REPO_BRANCH }}_firmware_${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
          path: openwrt/artifact/firmware/

      - name: ä¸Šä¼ é…ç½®æ–‡ä»¶
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_BUILDINFO == 'true' && !cancelled()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.Firmware_Name }}_${{ env.REPO_BRANCH }}_buildinfo${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
          path: openwrt/artifact/buildinfo/

      - name: ä¸Šä¼ æ’ä»¶
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_PACKAGE == 'true' && !cancelled()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.Firmware_Name }}_${{ env.REPO_BRANCH }}_package${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
          path: openwrt/artifact/package/

      - name: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
        id: tag
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true' && !cancelled()
        run: |
          echo "release_tag=$(date +"%Y.%m.%d.%H.%M")-${{ env.Firmware_Name }}" >> $GITHUB_OUTPUT
          echo "release_date=$(date +"%Y.%m.%d.%H.%M")" >> $GITHUB_OUTPUT
          touch release.txt
          echo "
          â˜… æºç  : ${{ env.REPO_URL }} 
          â˜… åˆ†æ”¯ : ${{ env.REPO_BRANCH }} 
          â˜… æ„Ÿè°¢æºç ä½œè€…æ— ç§åˆ†äº«ï¼
          
          â° ç¼–è¯‘æ—¶é—´ï¼š${{ env.FILE_TIME1 }}
          
          ğŸˆ å†…æ ¸ç‰ˆæœ¬ï¼š${{ env.KERNEL_PATCHVER }}
          
          ğŸ‰ ç¼–è¯‘ç‰ˆæœ¬ï¼š${{ env.DISTRIB_REVISION }}
          
          ğŸ–¥ ç®¡ç†åœ°å€ï¼š192.168.8.1 
          
          ğŸŒ´ åç§°ï¼šroot
          
          ğŸ›  å¯†ç ï¼špassword" >> release.txt
          echo "status=success" >> $GITHUB_OUTPUT
      
      - name: è‡ªåŠ¨å‘å¸ƒå›ºä»¶åˆ° Releases
        uses: softprops/action-gh-release@v2
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true' && !cancelled()
        env:
          GITHUB_TOKEN: ${{ secrets.GIT_USER_TOKEN }}
        with:
          name: ${{ steps.tag.outputs.release_date }} ${{ env.Firmware_Name }} ${{ env.name }}
          tag_name: ${{ steps.tag.outputs.release_tag }}
          body_path: release.txt
          files: openwrt/artifact/firmware/*

      - name: åˆ é™¤è¿è¡Œè®°å½•
        uses: Mattraks/delete-workflow-runs@v2
        if: steps.compile.outputs.status == 'success' && !cancelled()
        continue-on-error: true
        with:
          retain_days: 5     #ä¿ç•™æœ€åå¤šå°‘è®°å½•ä¸åˆ é™¤
          keep_minimum_runs: 0

      - name: åˆ é™¤è‡ªåŠ¨å‘å¸ƒçš„æ—§å›ºä»¶
        uses: dev-drprasad/delete-older-releases@master
        continue-on-error: true
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true' && !cancelled()
        with:
          keep_latest: 20        #ä¿ç•™å¤šå°‘ä¸ªreleasesä¸åˆ é™¤
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
  